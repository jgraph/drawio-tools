<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Validate and repair draw.io mxfile diagram files">
  <title>MxFile Tools - draw.io Tools</title>
  <link rel="icon" type="image/svg+xml" href="../assets/favicon.svg">
  <link rel="stylesheet" href="../styles/main.css">
  <style>
    .file-info {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-sm);
    }
    .file-info__item {
      background: var(--color-bg-secondary);
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--radius-sm);
      border: 1px solid var(--color-border);
    }
    .file-info__label {
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
    }
    .file-info__value {
      font-size: var(--font-size-sm);
      font-weight: 600;
    }
    .page-list {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    .page-list__item {
      padding: var(--spacing-xs) var(--spacing-sm);
      border-bottom: 1px solid var(--color-border);
      font-size: var(--font-size-xs);
    }
    .page-list__item:last-child {
      border-bottom: none;
    }
    .validation-summary {
      display: flex;
      gap: var(--spacing-md);
    }
    .validation-summary__item {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      font-size: var(--font-size-sm);
    }
    .validation-summary__icon {
      width: 16px;
      height: 16px;
    }
    .validation-summary__icon--success {
      color: var(--color-success);
    }
    .validation-summary__icon--error {
      color: var(--color-error);
    }
    .error-detail {
      font-family: var(--font-family-mono);
      font-size: var(--font-size-xs);
      background: var(--color-bg-tertiary);
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--radius-sm);
      margin-top: var(--spacing-xs);
      word-break: break-all;
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="header">
      <div class="container">
        <div class="header__inner">
          <a href="../" class="header__brand">
            <img src="../assets/logo.svg" alt="draw.io" class="header__logo">
            <span class="header__title">draw.io Tools</span>
          </a>
          <nav class="header__nav">
            <a href="../" class="header__link">All Tools</a>
            <a href="https://github.com/jgraph/drawio-tools" class="header__link" target="_blank">GitHub</a>
          </nav>
        </div>
      </div>
    </header>

    <main class="main-content">
      <div class="container tool-page">
        <nav class="breadcrumb">
          <a href="../" class="breadcrumb__link">Tools</a>
          <span class="breadcrumb__separator">/</span>
          <span class="breadcrumb__current">MxFile Tools</span>
        </nav>

        <div class="tool-header">
          <h1 class="tool-header__title">
            <svg class="tool-header__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 12l2 2 4-4"/>
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <path d="M14 2v6h6"/>
            </svg>
            MxFile Tools
          </h1>
          <p class="tool-header__description">
            Validate, analyze, and repair draw.io mxfile diagram files. Detects corruption and attempts automatic fixes.
          </p>
        </div>

        <div class="drop-zone mb-md" id="dropZone">
          <svg class="drop-zone__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <path d="M14 2v6h6"/>
            <path d="M12 18v-6"/>
            <path d="M9 15l3-3 3 3"/>
          </svg>
          <p class="drop-zone__text">Drop a .drawio file here or click to browse</p>
          <input type="file" id="fileInput" accept=".drawio,.xml" style="display: none;">
        </div>

        <div id="contentSection" style="display: none;">
          <div class="textarea-container mb-md">
            <textarea
              id="textarea"
              placeholder="Paste mxfile content here..."
              spellcheck="false"
              autocomplete="off"
              autocorrect="off"
              autocapitalize="off"
              rows="12"
            ></textarea>
            <div class="textarea-footer">
              <span><span id="charCount">0</span> chars</span>
              <button type="button" class="btn btn--sm btn--secondary" id="clearBtn">Clear</button>
            </div>
          </div>

          <div id="fileInfoSection" class="file-info mb-md" style="display: none;">
            <div class="file-info__item">
              <div class="file-info__label">Pages</div>
              <div class="file-info__value" id="pageCount">-</div>
            </div>
            <div class="file-info__item">
              <div class="file-info__label">Host</div>
              <div class="file-info__value" id="fileHost">-</div>
            </div>
            <div class="file-info__item">
              <div class="file-info__label">Version</div>
              <div class="file-info__value" id="fileVersion">-</div>
            </div>
            <div class="file-info__item">
              <div class="file-info__label">Status</div>
              <div class="file-info__value" id="fileStatus">-</div>
            </div>
          </div>

          <div class="btn-row">
            <button type="button" class="btn btn--primary" id="validateBtn">Validate</button>
            <button type="button" class="btn btn--secondary" id="correctBtn">Auto-Fix</button>
            <button type="button" class="btn btn--primary" id="downloadBtn">Download</button>
            <button type="button" class="btn btn--secondary" id="copyBtn">Copy</button>
          </div>

          <div id="validationResults" style="display: none;">
            <div class="validation-summary mb-sm" id="validationSummary"></div>
            <div class="output-panel" id="resultsPanel">
              <div class="output-panel__header">
                <span class="output-panel__title">Details</span>
              </div>
              <div class="output-panel__content">
                <ul class="validation-results" id="resultsList"></ul>
              </div>
            </div>
          </div>

          <div class="card mt-md" id="pageListCard" style="display: none;">
            <div class="card__header">
              <h3 class="card__title">Diagram Pages</h3>
            </div>
            <div class="card__body">
              <ul class="page-list" id="pageList"></ul>
            </div>
          </div>
        </div>

        <div id="alertContainer" class="mt-lg"></div>
      </div>
    </main>

    <footer class="footer">
      <div class="container">
        <div class="footer__inner">
          <span>&copy; 2026 JGraph Ltd. Apache-2.0 License.</span>
          <div class="footer__links">
            <a href="https://www.drawio.com">draw.io</a>
            <a href="https://github.com/jgraph/drawio-tools">GitHub</a>
          </div>
        </div>
      </div>
    </footer>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
  <script src="../utils/drawio-tools.js"></script>
  <script>
    (function() {
      var DT = window.DrawioTools;

      var dropZone = document.getElementById('dropZone');
      var fileInput = document.getElementById('fileInput');
      var contentSection = document.getElementById('contentSection');
      var textarea = document.getElementById('textarea');
      var charCount = document.getElementById('charCount');
      var alertContainer = document.getElementById('alertContainer');
      var fileInfoSection = document.getElementById('fileInfoSection');
      var validationResults = document.getElementById('validationResults');
      var validationSummary = document.getElementById('validationSummary');
      var resultsList = document.getElementById('resultsList');
      var pageListCard = document.getElementById('pageListCard');
      var pageList = document.getElementById('pageList');

      function updateCharCount() {
        charCount.textContent = textarea.value.length.toLocaleString();
      }

      textarea.addEventListener('input', function() {
        updateCharCount();
        analyzeContent();
      });

      function showAlert(message, type) {
        type = type || 'info';
        var alert = document.createElement('div');
        alert.className = 'alert alert--' + type;
        alert.textContent = message;
        alertContainer.innerHTML = '';
        alertContainer.appendChild(alert);
        setTimeout(function() { alert.remove(); }, 5000);
      }

      function loadContent(content, filename) {
        textarea.value = content;
        updateCharCount();
        contentSection.style.display = 'block';
        analyzeContent();

        if (filename) {
          showAlert('Loaded: ' + filename, 'success');
        }
      }

      function escapeHtml(text) {
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function analyzeContent() {
        var content = textarea.value.trim();

        if (!content) {
          fileInfoSection.style.display = 'none';
          pageListCard.style.display = 'none';
          validationResults.style.display = 'none';
          return;
        }

        if (!DT.isMxFile(content)) {
          fileInfoSection.style.display = 'none';
          pageListCard.style.display = 'none';
          return;
        }

        var info = DT.getMxFileInfo(content);
        var names = DT.getDiagramNames(content);

        if (info) {
          fileInfoSection.style.display = 'block';
          document.getElementById('pageCount').textContent = info.pages;
          document.getElementById('fileHost').textContent = info.host || '-';
          document.getElementById('fileVersion').textContent = info.version || '-';
          document.getElementById('fileStatus').textContent = 'Loaded';

          if (names.length > 0) {
            pageListCard.style.display = 'block';
            var html = '';
            for (var i = 0; i < names.length; i++) {
              html += '<li class="page-list__item"><span>Page ' + (i + 1) + ': ' + escapeHtml(names[i]) + '</span></li>';
            }
            pageList.innerHTML = html;
          }
        }
      }

      function displayValidationResults(result) {
        validationResults.style.display = 'block';

        if (result.valid) {
          validationSummary.innerHTML = '<div class="validation-summary__item">' +
            '<svg class="validation-summary__icon validation-summary__icon--success" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
            '<path d="M9 12l2 2 4-4"/><circle cx="12" cy="12" r="10"/></svg>' +
            '<span><strong>Valid</strong> - No errors found</span></div>';
          document.getElementById('fileStatus').textContent = 'Valid';
          document.getElementById('fileStatus').style.color = 'var(--color-success)';
        } else {
          validationSummary.innerHTML = '<div class="validation-summary__item">' +
            '<svg class="validation-summary__icon validation-summary__icon--error" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
            '<circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>' +
            '<span><strong>' + result.errors.length + ' error' + (result.errors.length > 1 ? 's' : '') + '</strong> found</span></div>';
          document.getElementById('fileStatus').textContent = 'Invalid';
          document.getElementById('fileStatus').style.color = 'var(--color-error)';
        }

        if (result.errors.length > 0) {
          var html = '';
          for (var i = 0; i < result.errors.length; i++) {
            var error = result.errors[i];
            var details = '';
            if (error.page) details += 'Page ' + error.page;
            if (error.position) details += details ? ' â€¢ Position ' + error.position : 'Position ' + error.position;

            html += '<li class="validation-results__item validation-results__item--error">' +
              '<svg class="validation-results__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
              '<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>' +
              '<div><div><strong>' + error.type.toUpperCase() + '</strong>: ' + escapeHtml(error.message) + '</div>' +
              (details ? '<div class="error-detail">' + details + '</div>' : '') + '</div></li>';
          }
          resultsList.innerHTML = html;
        } else {
          resultsList.innerHTML = '<li class="validation-results__item validation-results__item--success">' +
            '<svg class="validation-results__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
            '<path d="M9 12l2 2 4-4"/><circle cx="12" cy="12" r="10"/></svg>' +
            '<span>All validation checks passed</span></li>';
        }
      }

      document.getElementById('validateBtn').addEventListener('click', function() {
        var content = textarea.value.trim();

        if (!content) {
          showAlert('Please provide file content to validate', 'warning');
          return;
        }

        if (!DT.isMxFile(content)) {
          showAlert('Content does not appear to be a valid mxfile', 'error');
          return;
        }

        var result = DT.validateMxFile(content);
        displayValidationResults(result);
      });

      document.getElementById('correctBtn').addEventListener('click', function() {
        var content = textarea.value.trim();

        if (!content) {
          showAlert('Please provide file content to fix', 'warning');
          return;
        }

        var result = DT.correctMxFile(content);

        if (result.success) {
          textarea.value = result.data;
          updateCharCount();
          analyzeContent();
          showAlert(result.message, result.message.indexOf('already') >= 0 ? 'info' : 'success');

          var validation = DT.validateMxFile(result.data);
          displayValidationResults(validation);
        } else {
          showAlert(result.message, 'error');
        }
      });

      document.getElementById('downloadBtn').addEventListener('click', function() {
        DT.downloadFile(textarea.value, 'fixed.drawio');
        showAlert('File downloaded', 'success');
      });

      document.getElementById('copyBtn').addEventListener('click', function() {
        DT.copyToClipboard(textarea.value).then(function(success) {
          showAlert(success ? 'Copied to clipboard' : 'Failed to copy', success ? 'success' : 'error');
        });
      });

      document.getElementById('clearBtn').addEventListener('click', function() {
        textarea.value = '';
        updateCharCount();
        fileInfoSection.style.display = 'none';
        pageListCard.style.display = 'none';
        validationResults.style.display = 'none';
      });

      dropZone.addEventListener('click', function() { fileInput.click(); });

      fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
          var file = e.target.files[0];
          DT.readFileAsText(file).then(function(content) {
            loadContent(content, file.name);
          }).catch(function() {
            showAlert('Failed to read file', 'error');
          });
        }
      });

      DT.setupDropZone(
        dropZone,
        function(content, file) { loadContent(content, file.name); },
        {
          onDragEnter: function() { dropZone.classList.add('drop-zone--active'); },
          onDragLeave: function() { dropZone.classList.remove('drop-zone--active'); }
        }
      );

      DT.setupDropZone(
        textarea,
        function(content, file) { loadContent(content, file.name); },
        {
          onDragEnter: function() { textarea.style.borderColor = 'var(--drawio-blue)'; },
          onDragLeave: function() { textarea.style.borderColor = ''; }
        }
      );

      textarea.addEventListener('paste', function() {
        setTimeout(function() {
          contentSection.style.display = 'block';
          analyzeContent();
        }, 0);
      });

      contentSection.style.display = 'block';
    })();
  </script>
</body>
</html>
