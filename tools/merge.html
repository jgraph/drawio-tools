<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Stack multiple images vertically into a single image">
  <title>Image Merge - draw.io Tools</title>
  <link rel="icon" type="image/svg+xml" href="../assets/favicon.svg">
  <link rel="stylesheet" href="../styles/main.css">
  <style>
    .image-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: var(--spacing-sm);
    }
    .image-list__item {
      position: relative;
      background: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      overflow: hidden;
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .image-list__item img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    .image-list__item--empty {
      border-style: dashed;
      color: var(--color-text-secondary);
      font-size: var(--font-size-xs);
    }
    .result-container {
      max-width: 100%;
      overflow: auto;
      background: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      padding: var(--spacing-sm);
      text-align: center;
    }
    .result-container canvas {
      max-width: 100%;
      height: auto;
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="header">
      <div class="container">
        <div class="header__inner">
          <a href="../" class="header__brand">
            <img src="../assets/logo.svg" alt="draw.io" class="header__logo">
            <span class="header__title">draw.io Tools</span>
          </a>
          <nav class="header__nav">
            <a href="../" class="header__link">All Tools</a>
            <a href="https://github.com/jgraph/drawio-tools" class="header__link" target="_blank">GitHub</a>
          </nav>
        </div>
      </div>
    </header>

    <main class="main-content">
      <div class="container tool-page">
        <nav class="breadcrumb">
          <a href="../" class="breadcrumb__link">Tools</a>
          <span class="breadcrumb__separator">/</span>
          <span class="breadcrumb__current">Image Merge</span>
        </nav>

        <div class="tool-header">
          <h1 class="tool-header__title">
            <svg class="tool-header__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="7" height="7"/>
              <rect x="14" y="3" width="7" height="7"/>
              <rect x="3" y="14" width="7" height="7"/>
              <rect x="14" y="14" width="7" height="7"/>
            </svg>
            Image Merge
          </h1>
          <p class="tool-header__description">
            Stack multiple images vertically into a single combined image. Useful for creating long-form documentation or scrollable diagrams.
          </p>
        </div>

        <div class="drop-zone mb-md" id="dropZone">
          <svg class="drop-zone__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="7" height="7"/>
            <rect x="14" y="3" width="7" height="7"/>
            <rect x="3" y="14" width="7" height="7"/>
            <rect x="14" y="14" width="7" height="7"/>
          </svg>
          <p class="drop-zone__text">Drop images here (<span id="imageCount">0</span> loaded)</p>
          <input type="file" id="fileInput" accept="image/*" multiple style="display: none;">
        </div>

        <div class="image-list mb-sm" id="imageList">
          <div class="image-list__item image-list__item--empty">No images</div>
        </div>

        <div class="btn-row mb-md">
          <button type="button" class="btn btn--primary" id="createBtn" disabled>Stack</button>
          <button type="button" class="btn btn--secondary" id="resetBtn">Reset</button>
          <button type="button" class="btn btn--primary" id="downloadBtn" style="display: none;">Download</button>
        </div>

        <div id="resultCard" style="display: none;">
          <div class="result-container" id="resultContainer"></div>
          <div class="text-muted text-center" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);" id="resultInfo"></div>
        </div>

        <div id="alertContainer" class="mt-lg"></div>
      </div>
    </main>

    <footer class="footer">
      <div class="container">
        <div class="footer__inner">
          <span>&copy; 2026 JGraph Ltd. Apache-2.0 License.</span>
          <div class="footer__links">
            <a href="https://www.drawio.com">draw.io</a>
            <a href="https://github.com/jgraph/drawio-tools">GitHub</a>
          </div>
        </div>
      </div>
    </footer>
  </div>

  <script src="../utils/drawio-tools.js"></script>
  <script>
    (function() {
      var DT = window.DrawioTools;

      var dropZone = document.getElementById('dropZone');
      var fileInput = document.getElementById('fileInput');
      var imageList = document.getElementById('imageList');
      var imageCount = document.getElementById('imageCount');
      var createBtn = document.getElementById('createBtn');
      var resultCard = document.getElementById('resultCard');
      var resultContainer = document.getElementById('resultContainer');
      var resultInfo = document.getElementById('resultInfo');
      var alertContainer = document.getElementById('alertContainer');

      var images = [];
      var resultCanvas = null;

      function showAlert(message, type) {
        type = type || 'info';
        var alert = document.createElement('div');
        alert.className = 'alert alert--' + type;
        alert.textContent = message;
        alertContainer.innerHTML = '';
        alertContainer.appendChild(alert);
        setTimeout(function() { alert.remove(); }, 3000);
      }

      function updateImageList() {
        imageCount.textContent = images.length;
        createBtn.disabled = images.length === 0;

        if (images.length === 0) {
          imageList.innerHTML = '<div class="image-list__item image-list__item--empty">No images</div>';
        } else {
          var html = '';
          for (var i = 0; i < images.length; i++) {
            html += '<div class="image-list__item" title="' + images[i].width + '×' + images[i].height + '"><img src="' + images[i].src + '" alt="Image ' + (i + 1) + '"></div>';
          }
          imageList.innerHTML = html;
        }
      }

      function addFiles(files) {
        var promises = [];

        for (var i = 0; i < files.length; i++) {
          (function(file) {
            if (!file.type.startsWith('image/')) return;

            var promise = DT.readFileAsDataURL(file).then(function(dataUrl) {
              return new Promise(function(resolve, reject) {
                var img = new Image();
                img.onload = function() { resolve(img); };
                img.onerror = reject;
                img.src = dataUrl;
              });
            }).then(function(img) {
              images.push(img);
            }).catch(function(error) {
              console.error('Failed to load image:', error);
            });

            promises.push(promise);
          })(files[i]);
        }

        Promise.all(promises).then(function() {
          updateImageList();
          showAlert(images.length + ' image(s) loaded', 'success');
        });
      }

      dropZone.addEventListener('click', function() { fileInput.click(); });

      dropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        dropZone.classList.add('drop-zone--active');
      });

      dropZone.addEventListener('dragleave', function() {
        dropZone.classList.remove('drop-zone--active');
      });

      dropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        dropZone.classList.remove('drop-zone--active');
        if (e.dataTransfer.files.length > 0) {
          addFiles(Array.prototype.slice.call(e.dataTransfer.files));
        }
      });

      fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
          addFiles(Array.prototype.slice.call(e.target.files));
        }
      });

      createBtn.addEventListener('click', function() {
        if (images.length === 0) return;

        try {
          var width = 0;
          var height = 0;

          for (var i = 0; i < images.length; i++) {
            width = Math.max(width, images[i].width);
            height += images[i].height;
          }

          var canvas = document.createElement('canvas');
          canvas.width = width;
          canvas.height = height;

          var ctx = canvas.getContext('2d');
          var top = 0;

          for (var j = 0; j < images.length; j++) {
            ctx.drawImage(images[j], 0, top);
            top += images[j].height;
          }

          resultContainer.innerHTML = '';
          resultContainer.appendChild(canvas);
          resultCanvas = canvas;

          resultInfo.textContent = width + '×' + height + ' pixels';
          resultCard.style.display = '';
          document.getElementById('downloadBtn').style.display = '';

          showAlert('Stack created', 'success');
        } catch (error) {
          showAlert('Error creating stack: ' + error.message, 'error');
        }
      });

      document.getElementById('resetBtn').addEventListener('click', function() {
        images = [];
        updateImageList();
        resultCard.style.display = 'none';
        document.getElementById('downloadBtn').style.display = 'none';
        resultCanvas = null;
      });

      document.getElementById('downloadBtn').addEventListener('click', function() {
        if (!resultCanvas) return;

        var link = document.createElement('a');
        link.download = 'merged-image.png';
        link.href = resultCanvas.toDataURL('image/png');
        link.click();

        showAlert('Image downloaded', 'success');
      });

      updateImageList();
    })();
  </script>
</body>
</html>
