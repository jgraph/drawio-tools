<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Generate draw.io diagrams from natural language descriptions using AI">
  <title>AI Generate - draw.io Tools</title>
  <link rel="icon" type="image/svg+xml" href="../assets/favicon.svg">
  <link rel="stylesheet" href="../styles/main.css">
  <style>
    .preview-container {
      position: relative;
      height: 350px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      overflow: hidden;
      background: var(--color-bg-secondary);
    }
    .preview-container iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    .preview-placeholder {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-text-secondary);
      font-size: var(--font-size-xs);
    }
    .preview-loading {
      background: var(--color-bg-secondary) url('data:image/svg+xml;base64,77u/PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAyMDAgMjAwJz48Y2lyY2xlIGZpbGw9JyM4MDgwODAnIHN0cm9rZT0nIzgwODA4MCcgc3Ryb2tlLXdpZHRoPScxNScgcj0nMTUnIGN4PSczNScgY3k9JzEwMCc+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0nY3gnIGNhbGNNb2RlPSdzcGxpbmUnIGR1cj0nNC4yJyB2YWx1ZXM9JzM1OzE2NTsxNjU7MzU7MzUnIGtleVNwbGluZXM9JzAgLjEgLjUgMTswIC4xIC41IDE7MCAuMSAuNSAxOzAgLjEgLjUgMScgcmVwZWF0Q291bnQ9J2luZGVmaW5pdGUnIGJlZ2luPScwJz48L2FuaW1hdGU+PC9jaXJjbGU+PC9zdmc+') no-repeat center center;
    }
    .engine-info {
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
      margin-top: var(--spacing-xs);
    }
    .config-row {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-sm);
      align-items: flex-end;
    }
    .config-field {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .config-field label {
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
    }
    .config-field select,
    .config-field input {
      padding: var(--spacing-xs) var(--spacing-sm);
      font-size: var(--font-size-xs);
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="header">
      <div class="container">
        <div class="header__inner">
          <a href="../" class="header__brand">
            <img src="../assets/logo.svg" alt="draw.io" class="header__logo">
            <span class="header__title">draw.io Tools</span>
          </a>
          <nav class="header__nav">
            <a href="../" class="header__link">All Tools</a>
            <a href="https://github.com/jgraph/drawio-tools/discussions/3" class="header__link" target="_blank">Help</a>
          </nav>
        </div>
      </div>
    </header>

    <main class="main-content">
      <div class="container tool-page">
        <nav class="breadcrumb">
          <a href="../" class="breadcrumb__link">Tools</a>
          <span class="breadcrumb__separator">/</span>
          <span class="breadcrumb__current">AI Generate</span>
        </nav>

        <div class="tool-header">
          <h1 class="tool-header__title">
            <svg class="tool-header__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2L2 7l10 5 10-5-10-5z"/>
              <path d="M2 17l10 5 10-5"/>
              <path d="M2 12l10 5 10-5"/>
            </svg>
            AI Generate
          </h1>
          <p class="tool-header__description">
            Generate draw.io diagrams from natural language descriptions using AI (ChatGPT, Gemini) or paste Mermaid syntax directly.
          </p>
        </div>

        <div class="textarea-container mb-sm">
          <textarea
            id="prompt"
            rows="3"
            placeholder="Describe your diagram or paste Mermaid syntax..."
            spellcheck="false"
            autocomplete="off"
          ></textarea>
        </div>

        <div class="config-row mb-sm">
          <div class="config-field">
            <label for="engine">Engine</label>
            <select id="engine">
              <option value="chatgpt">ChatGPT</option>
              <option value="gemini">Gemini</option>
              <option value="mermaidjs">Mermaid</option>
              <option value="drawio">draw.io XML</option>
            </select>
          </div>

          <div class="config-field" id="modelSection">
            <label for="model">Model</label>
            <select id="model">
              <option value="gpt-4.5-preview">GPT-4.5 Preview</option>
              <option value="gpt-4o" selected>GPT-4o</option>
              <option value="gpt-4o-mini">GPT-4o mini</option>
              <option value="gpt-4-turbo">GPT-4 Turbo</option>
              <option value="gpt-4">GPT-4</option>
              <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
              <option value="gemini-2.5-pro-exp-03-25">Gemini 2.5 Pro</option>
              <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
              <option value="gemini-2.0-flash-lite">Gemini 2.0 Flash-Lite</option>
              <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
              <option value="claude-3-7-sonnet-latest">Claude 3.7 Sonnet</option>
              <option value="claude-3-5-haiku-latest">Claude 3.5 Haiku</option>
              <option value="claude-3-5-sonnet-latest">Claude 3.5 Sonnet v2</option>
            </select>
          </div>

          <div class="config-field" id="keySection">
            <label for="apikey">API Key</label>
            <input type="password" id="apikey" placeholder="API key">
          </div>

          <div class="config-field" id="promptSection">
            <label for="aiPromptSelect">Output</label>
            <select id="aiPromptSelect">
              <option id="mermaidOption"
                value='Write a MermaidJS declaration for "%prompt%" and return only the valid MermaidJS syntax without any other text do not return a gantt chart unless specifically requested'
                selected>Mermaid</option>
              <option id="drawioOption"
                value='Write a draw.io file for "%prompt%" and return only the valid XML syntax without any other text'>
                draw.io XML</option>
            </select>
          </div>

          <button type="button" class="btn btn--primary" id="generateBtn">Generate</button>
          <button type="button" class="btn btn--secondary" id="unescapeBtn">Unescape</button>
        </div>

        <div class="preview-container mb-sm" id="previewContainer">
          <div class="preview-placeholder" id="placeholder">
            Generated diagram will appear here
          </div>
          <iframe id="preview" allowtransparency="true" style="display: none;"></iframe>
        </div>
        <div class="engine-info" id="info"></div>

        <div class="btn-row">
          <button type="button" class="btn btn--primary" id="viewBtn" disabled>View Full Screen</button>
          <button type="button" class="btn btn--secondary" id="editBtn" disabled>Edit in draw.io</button>
        </div>

        <div id="alertContainer"></div>
      </div>
    </main>

    <footer class="footer">
      <div class="container">
        <div class="footer__inner">
          <span>&copy; 2026 JGraph Ltd. Apache-2.0 License.</span>
          <div class="footer__links">
            <a href="https://www.drawio.com">draw.io</a>
            <a href="https://github.com/jgraph/drawio-tools">GitHub</a>
          </div>
        </div>
      </div>
    </footer>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
  <script src="../utils/drawio-tools.js"></script>
  <script>
    (function() {
      var DT = window.DrawioTools;

      var promptEl = document.getElementById('prompt');
      var engineEl = document.getElementById('engine');
      var modelEl = document.getElementById('model');
      var apikeyEl = document.getElementById('apikey');
      var aiPromptSelectEl = document.getElementById('aiPromptSelect');
      var generateBtn = document.getElementById('generateBtn');
      var viewBtn = document.getElementById('viewBtn');
      var editBtn = document.getElementById('editBtn');
      var previewEl = document.getElementById('preview');
      var placeholderEl = document.getElementById('placeholder');
      var previewContainer = document.getElementById('previewContainer');
      var infoEl = document.getElementById('info');
      var alertContainer = document.getElementById('alertContainer');

      var modelSection = document.getElementById('modelSection');
      var keySection = document.getElementById('keySection');
      var promptSection = document.getElementById('promptSection');

      var urlParams = new URLSearchParams(window.location.hash.substring(1));

      if (urlParams.get('key')) {
        apikeyEl.value = urlParams.get('key');
      }

      function showAlert(message, type) {
        type = type || 'info';
        var alert = document.createElement('div');
        alert.className = 'alert alert--' + type;
        alert.textContent = message;
        alertContainer.innerHTML = '';
        alertContainer.appendChild(alert);
        setTimeout(function() { alert.remove(); }, 5000);
      }

      function engineChanged() {
        var engine = engineEl.value;
        var prefix = engine === 'chatgpt' ? 'gpt' : engine;

        var isAI = engine !== 'mermaidjs' && engine !== 'drawio';
        modelSection.style.display = isAI ? '' : 'none';
        keySection.style.display = isAI ? '' : 'none';
        promptSection.style.display = isAI ? '' : 'none';

        var options = modelEl.options;
        for (var i = 0; i < options.length; i++) {
          options[i].style.display = options[i].value.indexOf(prefix) === 0 ? '' : 'none';
        }

        if (engine === 'gemini') {
          modelEl.value = 'gemini-2.0-flash';
        } else if (engine === 'chatgpt') {
          modelEl.value = 'gpt-4o-mini';
        }
      }

      engineEl.addEventListener('change', engineChanged);
      engineChanged();

      document.getElementById('unescapeBtn').addEventListener('click', function() {
        var input = promptEl.value;
        input = input.replace(/\\u([0-9A-Fa-f]{4})/g, function(match, group) {
          return String.fromCharCode(parseInt(group, 16));
        });
        promptEl.value = input.replace(/\\n/g, '\n');
      });

      function compressData(data) {
        if (data && data.length > 0) {
          var tmp = pako.deflateRaw(encodeURIComponent(data));
          return btoa(String.fromCharCode.apply(null, new Uint8Array(tmp)));
        }
        return data;
      }

      function extractCode(input) {
        var result = input;

        if (result.indexOf('```mermaid') >= 0) {
          result = result.substring(result.indexOf('```mermaid') + 11);
        } else if (result.indexOf('```xml') >= 0) {
          result = result.substring(result.indexOf('```xml') + 7);
        } else {
          var start = result.indexOf('```');
          if (start === 0) {
            result = result.substring(3);
          } else if (start > 0) {
            result = result.substring(0, start + 3);
          }
        }

        result = result
          .replace(/^```mermaid\n/, '')
          .replace(/^```xml\n/, '')
          .replace(/\n```\n$/, '')
          .replace(/\n```$/, '')
          .replace(/<\?xml[^>]+\?>\s*/, '');

        return result;
      }

      function sendPostRequest(url, data, engine, model, apikey) {
        var headers = { 'Content-Type': 'application/json' };

        if (engine === 'chatgpt') {
          headers['Authorization'] = 'Bearer ' + apikey;
        } else if (engine === 'claude') {
          headers['x-api-key'] = apikey;
          headers['anthropic-version'] = '2023-06-01';
          headers['anthropic-dangerous-direct-browser-access'] = 'true';
        }

        infoEl.textContent = 'Engine: ' + engine + ' | Model: ' + model + ' | Waiting...';
        var t0 = Date.now();

        var controller = new AbortController();
        var timeoutId = setTimeout(function() { controller.abort(); }, 60000);

        return fetch(url, {
          method: 'POST',
          headers: headers,
          body: JSON.stringify(data),
          signal: controller.signal
        }).then(function(response) {
          if (!response.ok) {
            throw new Error('HTTP error! Status: ' + response.status);
          }
          return response.json();
        }).then(function(jsonResponse) {
          var dt = Date.now() - t0;
          infoEl.textContent = 'Engine: ' + engine + ' | Model: ' + model + ' | Time: ' + dt + 'ms';
          return jsonResponse;
        }).finally(function() {
          clearTimeout(timeoutId);
        });
      }

      function preview(value) {
        var params = 'lightbox=1&dark=auto&border=10&edit=_blank';
        var prefix = 'https://www.draw.io/?';
        var data = compressData(value);

        var createObj = {
          type: value.indexOf('<') === 0 ? 'xml' : 'mermaid',
          compressed: true,
          data: data
        };

        var create = '#create=' + encodeURIComponent(JSON.stringify(createObj));
        var link = prefix + params + create;

        previewEl.src = link;
        previewEl.style.display = 'block';
        placeholderEl.style.display = 'none';
        previewContainer.classList.remove('preview-loading');

        viewBtn.disabled = false;
        editBtn.disabled = false;
        generateBtn.disabled = false;

        viewBtn.onclick = function() { window.open(prefix + params + create); };
        editBtn.onclick = function() { window.open(prefix + create); };
      }

      function generate() {
        var engine = engineEl.value;
        var model = modelEl.value;
        var apikey = apikeyEl.value;
        var prompt = promptEl.value || 'a random diagram';

        if (engine !== 'mermaidjs' && engine !== 'drawio' && !apikey) {
          showAlert('API key is required for ' + engine, 'error');
          return;
        }

        generateBtn.disabled = true;
        viewBtn.disabled = true;
        editBtn.disabled = true;
        previewEl.style.display = 'none';
        placeholderEl.style.display = 'none';
        previewContainer.classList.add('preview-loading');

        var aiprompt = aiPromptSelectEl.value.replace(/%prompt%/g, prompt);

        if (engine === 'gemini') {
          var url = 'https://generativelanguage.googleapis.com/v1beta/models/' + model + ':generateContent?key=' + apikey;
          sendPostRequest(
            url,
            { contents: [{ parts: [{ text: aiprompt }] }] },
            engine,
            model,
            apikey
          ).then(function(response) {
            preview(extractCode(response.candidates[0].content.parts[0].text));
          }).catch(function(error) {
            console.error('Error:', error);
            showAlert('Error: ' + error.message, 'error');
            generateBtn.disabled = false;
            previewContainer.classList.remove('preview-loading');
            placeholderEl.style.display = 'flex';
          });
        } else if (engine === 'chatgpt') {
          var url = 'https://api.openai.com/v1/chat/completions';
          sendPostRequest(
            url,
            { model: model, messages: [{ role: 'user', content: aiprompt }] },
            engine,
            model,
            apikey
          ).then(function(response) {
            preview(extractCode(response.choices[0].message.content));
          }).catch(function(error) {
            console.error('Error:', error);
            showAlert('Error: ' + error.message, 'error');
            generateBtn.disabled = false;
            previewContainer.classList.remove('preview-loading');
            placeholderEl.style.display = 'flex';
          });
        } else if (engine === 'mermaidjs' || engine === 'drawio') {
          preview(prompt);
        } else {
          showAlert('Invalid engine', 'error');
          generateBtn.disabled = false;
          previewContainer.classList.remove('preview-loading');
          placeholderEl.style.display = 'flex';
        }
      }

      generateBtn.addEventListener('click', generate);

      promptEl.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          generate();
        }
      });

      DT.setupDropZone(
        promptEl,
        function(content, file) {
          if (file.type.indexOf('image/') === 0) {
            DT.readFileAsDataURL(file).then(function(dataUrl) {
              promptEl.value = dataUrl;
            });
          } else {
            promptEl.value = content;
          }
        }
      );

      promptEl.focus();

      if (urlParams.get('engine')) {
        engineEl.value = urlParams.get('engine');
        engineChanged();
      }

      if (urlParams.get('prompt')) {
        promptEl.value = decodeURIComponent(urlParams.get('prompt'));
        generate();
      }
    })();
  </script>
</body>
</html>
